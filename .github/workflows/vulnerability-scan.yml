name: Vulnerability Scanning

on:
  push:
    paths:
      - 'requirements.txt'
  pull_request:
    paths:
      - 'requirements.txt'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  vulnerability-scan:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create reports directory
        run: |
          mkdir -p ~/test-runner/vulnerability-reports
          echo "Report will be saved to: ~/test-runner/vulnerability-reports"

      - name: Install Trivy
        run: |
          # Check if trivy is already installed
          if ! command -v trivy &> /dev/null; then
            echo "Installing Trivy..."
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install trivy -y
          else
            echo "Trivy is already installed"
            trivy --version
          fi

      - name: Run Trivy vulnerability scan on requirements.txt
        run: |
          echo "üîç Scanning requirements.txt for vulnerabilities..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_FILE="~/test-runner/vulnerability-reports/trivy-report-${TIMESTAMP}.txt"

          # Scan the requirements.txt file
          trivy fs --scanners vuln --severity HIGH,CRITICAL --format table --output "${REPORT_FILE}" requirements.txt || true

          # Also create a JSON report for easier parsing
          trivy fs --scanners vuln --severity HIGH,CRITICAL --format json --output "${REPORT_FILE%.txt}.json" requirements.txt || true

          echo "üìÑ Reports saved to:"
          echo "  - ${REPORT_FILE}"
          echo "  - ${REPORT_FILE%.txt}.json"

      - name: Display scan results
        run: |
          echo "=== VULNERABILITY SCAN RESULTS ==="
          LATEST_REPORT=$(ls -t ~/test-runner/vulnerability-reports/trivy-report-*.txt | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            cat "$LATEST_REPORT"
          else
            echo "No report found"
          fi

      - name: Print summary
        run: |
          echo ""
          echo "‚úÖ Vulnerability scan completed!"
          echo "üìÅ All reports are stored in: ~/test-runner/vulnerability-reports/"
          ls -lh ~/test-runner/vulnerability-reports/